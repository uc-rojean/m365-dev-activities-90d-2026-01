
name: Daily Read-only Telemetry

on:
  schedule:
    - cron: '30 0 * * *'  # runs 00:30 UTC = 08:30 GMT+8 daily
  workflow_dispatch:

jobs:
  readonly-telemetry:
    runs-on: ubuntu-latest
    env:
      M365_TENANT_ID: ${{ secrets.M365_TENANT_ID }}
      M365_TENANT_DOMAIN: ${{ secrets.M365_TENANT_DOMAIN }} # unused in script, OK to keep
      M365_CLIENT_ID: ${{ secrets.M365_CLIENT_ID }}
      M365_CLIENT_SECRET: ${{ secrets.M365_CLIENT_SECRET }}
      GRAPH_SCOPES: ${{ secrets.GRAPH_SCOPES }} # e.g., "https://graph.microsoft.com/.default"
      TEAMS_WORKFLOW_URL: ${{ secrets.TEAMS_WORKFLOW_URL }} # optional: Teams Workflow webhook
      GRAPH_MAX_PAGES: 50
      GRAPH_DELAY_MS: 150

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Setup Node"
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: "Sanity - show Node and npm"
        run: |
          node -v
          npm -v

      - name: "Install MSAL (runtime only)"
        run: npm i @azure/msal-node

      - name: "Prepare folders"
        run: mkdir -p logs reports

      - name: "Read-only Graph telemetry (extended: pagination + delta + CSV)"
        run: node scripts/readonly-telemetry-extended.cjs

      - name: "Upload run artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: uc-day-readonly-telemetry
          path: |
            reports/*.json
            reports/*.csv
            logs/*.txt
